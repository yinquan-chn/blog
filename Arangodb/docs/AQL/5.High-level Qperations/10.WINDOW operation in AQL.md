[WINDOW operation in AQL](https://docs.arangodb.com/3.11/aql/high-level-operations/window/)

# WINDOW 操作
利用WINDOW操作对相邻文档或基于文档属性相对值范围的值区间进行滑动窗口聚合，以计算累计总额、滚动平均值以及其他统计属性。

WINDOW操作主要用于对查询结果中相邻文档或者说是前后行进行聚合操作。它也可以基于文档属性的值或持续时间范围进行聚合。

该操作类似于COLLECT AGGREGATE操作对一组查询行进行处理。然而，与将多行查询结果合并成单个结果组的COLLECT操作不同，WINDOW操作为每行查询结果生成一个独立的结果：

- 函数评估发生的行被称为当前行。
- 与当前行相关的、函数在其上进行评估的所有查询行构成了当前行的窗口帧。

窗口帧相对于当前行的定义如下：
- 通过定义窗口帧为从查询开始到当前行的所有行，可以计算每行的累计总额。
- 通过定义窗口帧为当前行两侧延伸N行，可以计算滚动平均值。

## 语法
WINDOW 操作有两种用法

基于行（相邻文档）：
```
WINDOW { preceding: numPrecedingRows, following: numFollowingRows } AGGREGATE variableName = aggregateExpression
```

基于范围（值或持续时间范围）：
```
WINDOW rangeValue WITH { preceding: offsetPreceding, following: offsetFollowing } AGGREGATE variableName = aggregateExpression
```

聚合表达式中支持对以下函数的调用：
- LENGTH() / COUNT()
- MIN()
- MAX()
- SUM()
- AVERAGE() / AVG()
- STDDEV_POPULATION() / STDDEV()
- STDDEV_SAMPLE()
- VARIANCE_POPULATION() / VARIANCE()
- VARIANCE_SAMPLE()
- UNIQUE()
- SORTED_UNIQUE()
- COUNT_DISTINCT() / COUNT_UNIQUE()
- BIT_AND()
- BIT_OR()
- BIT_XOR()

## 基于行的聚合

WINDOW的第一种语法形式允许在当前行之后或之前的固定数量的行上进行聚合。也可以定义所有前面或后面的行都应该聚合（“unbounded”）。行数必须在查询编译时确定。

下面的查询演示了使用窗口框架来计算运行总计以及根据当前行及其前后的行计算的滚动平均值：
```
FOR t IN observations
  SORT t.time
  WINDOW { preceding: 1, following: 1 }
  AGGREGATE rollingAverage = AVG(t.val), rollingSum = SUM(t.val)
  WINDOW { preceding: "unbounded", following: 0}
  AGGREGATE cumulativeSum = SUM(t.val)
  RETURN {
    time: t.time,
    subject: t.subject,
    val: t.val,
    rollingAverage, // average of the window's values
    rollingSum,     // sum of the window's values
    cumulativeSum   // running total
  }
```
```
[ 
  { 
    "time" : "2021-05-25 07:00:00", 
    "subject" : "st113", 
    "val" : 10, 
    "rollingAverage" : 5, 
    "rollingSum" : 10,  // 此处的10就是 10 + 0
    "cumulativeSum" : 10 
  }, 
  { 
    "time" : "2021-05-25 07:00:00", 
    "subject" : "xh458", 
    "val" : 0, 
    "rollingAverage" : 6.333333333333333, 
    "rollingSum" : 19,  // 此处的19就是 10 + 0 + 9
    "cumulativeSum" : 10 
  }, 
  { 
    "time" : "2021-05-25 07:15:00", 
    "subject" : "st113", 
    "val" : 9, 
    "rollingAverage" : 6.333333333333333, 
    "rollingSum" : 19, 
    "cumulativeSum" : 19 
  }, 
  { 
    "time" : "2021-05-25 07:15:00", 
    "subject" : "xh458", 
    "val" : 10, 
    "rollingAverage" : 14.666666666666666, 
    "rollingSum" : 44,  // 此处的44就是 9 + 10 + 25
    "cumulativeSum" : 29 
  }, 
  { 
    "time" : "2021-05-25 07:30:00", 
    "subject" : "st113", 
    "val" : 25, 
    "rollingAverage" : 13.333333333333334, 
    "rollingSum" : 40, 
    "cumulativeSum" : 54 
  }, 
  { 
    "time" : "2021-05-25 07:30:00", 
    "subject" : "xh458", 
    "val" : 5, 
    "rollingAverage" : 16.666666666666668, 
    "rollingSum" : 50, 
    "cumulativeSum" : 59 
  }, 
  { 
    "time" : "2021-05-25 07:45:00", 
    "subject" : "st113", 
    "val" : 20, 
    "rollingAverage" : 18.333333333333332, 
    "rollingSum" : 55, 
    "cumulativeSum" : 79 
  }, 
  { 
    "time" : "2021-05-25 07:45:00", 
    "subject" : "xh458", 
    "val" : 30, 
    "rollingAverage" : 25, 
    "rollingSum" : 75, 
    "cumulativeSum" : 109 
  }, 
  { 
    "time" : "2021-05-25 08:00:00", 
    "subject" : "xh458", 
    "val" : 25, 
    "rollingAverage" : 27.5, 
    "rollingSum" : 55, 
    "cumulativeSum" : 134 
  } 
]
```